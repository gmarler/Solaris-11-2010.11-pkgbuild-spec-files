--- libgpod-0.4.0/src/db-itunes-parser.h.orig	2006-09-26 21:56:06.786446000 -0400
+++ libgpod-0.4.0/src/db-itunes-parser.h	2006-09-26 21:59:12.012567000 -0400
@@ -22,6 +22,12 @@
  *
  */
 
+#if __GNUC__ > 2 || (__GNUC__ == 2 && __GNUC_MINOR__ > 4)
+#define GNUC_PACKED                             \
+  __attribute__((packed))
+#else   /* !__GNUC__ */
+#define GNUC_PACKED
+#endif
 
 #ifndef DB_PARSER_H
 #define DB_PARSER_H
@@ -497,7 +503,6 @@
 	gint32 action;
 	gchar  padding[44];
 	gint32 string_len;
-	gchar  string[];
 };
 
 struct _MhodHeaderSmartPlaylistRuleNonString {
@@ -512,7 +517,6 @@
 	guint64 to_value;
 	gint64  to_date;
 	guint64 to_unit;
-	gchar   unknown[20];
 };
 
 struct _MhodHeaderSmartPlaylistRule {
@@ -532,6 +536,7 @@
 		MhodHeaderSmartPlaylistRuleString rule_string;
 		MhodHeaderSmartPlaylistRuleNonString rule_non_string;
 	} rule;
+	gchar string[];
 };
 
 
@@ -579,7 +584,11 @@
 	gint32 digitised_date;
 	gint32 orig_img_size;
 	unsigned char padding[];
-} __attribute__((__packed__));
+} GNUC_PACKED;
+#ifndef ATTRIBUTE_PACKED
+#pragma pack()
+#endif
+
 /* I we don't put the 'packed' attribute above, some 64 bit systems
  * will pad the 64 bit integer to be aligned to an 8-byte boundary.
  * Hopefully there won't be any systems around that crash when
--- libgpod-0.4.0/src/itdb_itunesdb.c.orig	2006-09-26 21:59:59.620962000 -0400
+++ libgpod-0.4.0/src/itdb_itunesdb.c	2006-09-26 22:01:55.850377000 -0400
@@ -4491,6 +4491,17 @@
 }
 
 
+static gboolean haystack (gchar *filetype, gchar **desclist)
+{
+    gchar **dlp;
+    if (!filetype || !desclist) return FALSE;
+    for (dlp=desclist; *dlp; ++dlp)
+    {
+        if (strstr (filetype, *dlp)) return TRUE;
+    }
+    return FALSE;
+}
+
 /**
  * itdb_shuffle_write_file:
  * @itdb: the #Itdb_iTunesDB to write to disk
@@ -4505,18 +4516,6 @@
 gboolean itdb_shuffle_write_file (Itdb_iTunesDB *itdb,
 				  const gchar *filename, GError **error)
 {
-    auto gboolean haystack (gchar *filetype, gchar **desclist);
-    gboolean haystack (gchar *filetype, gchar **desclist)
-    {
-	gchar **dlp;
-	if (!filetype || !desclist) return FALSE;
-	for (dlp=desclist; *dlp; ++dlp)
-	{
-	    if (strstr (filetype, *dlp)) return TRUE;
-	}
-	return FALSE;
-    }
-
     FExport *fexp;
     GList *gl;
     WContents *cts;
--- libgpod-0.4.0/src/itdb_track.c.orig	2006-09-26 22:03:05.618286000 -0400
+++ libgpod-0.4.0/src/itdb_track.c	2006-09-26 22:04:10.344101000 -0400
@@ -69,21 +69,20 @@
     return track;
 }
 
-/* Attempt to set some of the unknowns to reasonable defaults */
-static void itdb_track_set_defaults (Itdb_Track *tr)
+static gboolean haystack (gchar *filetype, gchar **desclist)
 {
-    auto gboolean haystack (gchar *filetype, gchar **desclist);
-    gboolean haystack (gchar *filetype, gchar **desclist)
+    gchar **dlp;
+    if (!filetype || !desclist) return FALSE;
+    for (dlp=desclist; *dlp; ++dlp)
     {
-	gchar **dlp;
-	if (!filetype || !desclist) return FALSE;
-	for (dlp=desclist; *dlp; ++dlp)
-	{
-	    if (strstr (filetype, *dlp)) return TRUE;
-	}
-	return FALSE;
+        if (strstr (filetype, *dlp)) return TRUE;
     }
+    return FALSE;
+}
 
+/* Attempt to set some of the unknowns to reasonable defaults */
+static void itdb_track_set_defaults (Itdb_Track *tr)
+{
     gchar *mp3_desc[] = {"MPEG", "MP3", "mpeg", "mp3", NULL};
     gchar *mp4_desc[] = {"AAC", "MP4", "aac", "mp4", NULL};
     gchar *audible_subdesc[] = {"Audible", "audible", "Book", "book", NULL};
